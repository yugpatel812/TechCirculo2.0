<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>University Login System</title>
    <link rel="stylesheet" href="css/SignIn.css" />
  </head>
  <body>
    <div class="container">
      <div class="form-container" id="loginForm">
        <div class="form-header">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="school-icon"
          >
            <path d="m4 6 8-4 8 4" />
            <path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2" />
            <path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4" />
            <path d="M18 5v17" />
            <path d="M6 5v17" />
            <circle cx="12" cy="9" r="2" />
          </svg>
          <h1>Welcome Back To TechCirculo</h1>
          <p>Sign in</p>
        </div>

        <div class="error-message" id="loginError" style="display: none;"></div>

        <form id="loginFormElement">
          <div class="form-group">
            <label for="loginRole">Role</label>
            <select id="loginRole" required>
              <option value="student">Student</option>
              <option value="teacher">Teacher</option>
              <option value="alumni">Alumni</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input
              type="email"
              id="loginEmail"
              placeholder="...@paruluniversity.ac.in"
              required
            />
          </div>

          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input
              type="password"
              id="loginPassword"
              required
              placeholder="Enter 6-digit password"
            />
          </div>

          <button type="submit">Sign In</button>
        </form>
        
        <form action="/oauth2/authorization/google" method="GET">
          <button type="submit" class="login-with-google-btn">
            <img src="images/google_logo.png" alt="Google logo" style="width: 20px; height: 20px;">
            <p>Sign in with Google</p>
          </button>
        </form>

        <p class="switch-form">
          Don't have an account?
          <a href="#" onclick="toggleForm('register')">Register</a>
        </p>
      </div>

      <div class="form-container hidden" id="registerForm">
        <div class="form-header">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="school-icon"
          >
            <path d="m4 6 8-4 8 4" />
            <path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2" />
            <path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4" />
            <path d="M18 5v17" />
            <path d="M6 5v17" />
            <circle cx="12" cy="9" r="2" />
          </svg>
          <h1>Create Account</h1>
          <p>
            Welcome To TechCirculo-A central point where education and
            collaboration meet
          </p>
        </div>

        <div class="error-message" id="registerError" style="display: none;"></div>

        <form id="registerFormElement">
          <div class="form-group">
            <label for="registerRole">Role</label>
            <select id="registerRole" required>
              <option value="student">Student</option>
              <option value="teacher">Teacher</option>
              <option value="alumni">Alumni</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" required />
          </div>

          <div class="form-group">
            <label for="registerPassword">Password</label>
            <input type="password" id="registerPassword" required />
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" required />
          </div>

          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" required />
          </div>

          <button type="submit">Create Account</button>
        </form>

        <p class="switch-form">
          Already have an account?
          <a href="#" onclick="toggleForm('login')">Sign in</a>
        </p>
      </div>
    </div>

   <script>
  // Auto-detect backend URL (Works for both local & deployed environments)
  const BASE_URL = "http://localhost:8084/auth";
  console.log("Using Backend URL:", BASE_URL);

  // In-memory token storage (fallback for localStorage issues)
  let authToken = null;

  function storeToken(token) {
    authToken = token;
    try {
      if (typeof Storage !== "undefined") {
        localStorage.setItem("token", token);
        console.log("Token stored in localStorage");
      }
    } catch (error) {
      console.warn("localStorage not available, using memory storage:", error);
    }
  }

  function getToken() {
    try {
      if (typeof Storage !== "undefined" && localStorage.getItem("token")) {
        return localStorage.getItem("token");
      }
    } catch (error) {
      console.warn("localStorage access failed:", error);
    }
    return authToken;
  }

  function clearToken() {
    authToken = null;
    try {
      if (typeof Storage !== "undefined") {
        localStorage.removeItem("token");
      }
    } catch (error) {
      console.warn("localStorage access failed:", error);
    }
  }

  async function apiRequest(endpoint, method, body) {
    try {
      const requestOptions = {
        method,
        headers: { "Content-Type": "application/json" }
      };

      if (method !== "GET" && body) {
        requestOptions.body = JSON.stringify(body);
      }

      const response = await fetch(`${BASE_URL}/${endpoint}`, requestOptions);

      if (!response.ok) {
        let errorMessage;
        try {
          const errorData = await response.json();
          errorMessage = errorData.message || `HTTP error ${response.status}`;
        } catch {
          errorMessage = `HTTP error ${response.status}`;
        }
        throw new Error(errorMessage);
      }

      return await response.json();
    } catch (error) {
      console.error("API Request Error:", error);
      if (error.name === "TypeError" && error.message.includes("fetch")) {
        throw new Error("Network error: Unable to connect to server.");
      }
      throw error;
    }
  }

  function toggleForm(type) {
    document.getElementById("loginForm").classList.toggle("hidden", type === "register");
    document.getElementById("registerForm").classList.toggle("hidden", type !== "register");
  }

  function showError(element, message) {
    if (element) {
      element.textContent = message;
      element.style.display = "block";
    }
  }

  function hideError(element) {
    if (element) {
      element.style.display = "none";
    }
  }

  // âœ… Fixed redirect function
  function redirectToDashboard() {
    console.log("Redirecting to dashboard...");
    window.location.href = "/dashboard.html"; // Static file path
  }

  document.addEventListener("DOMContentLoaded", function () {
    const loginFormElement = document.getElementById("loginFormElement");
    if (loginFormElement) {
      loginFormElement.addEventListener("submit", async (e) => {
        e.preventDefault();
        const loginError = document.getElementById("loginError");
        hideError(loginError);

        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const role = document.getElementById("loginRole").value.toUpperCase();

        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.textContent = "Signing In...";
        submitButton.disabled = true;

        try {
          const data = await apiRequest("login", "POST", { email, password, role });

          if (data.token) {
            storeToken(data.token);
            alert("Login Successful!");
            redirectToDashboard();
          } else {
            throw new Error("No token received from server");
          }
        } catch (error) {
          showError(loginError, error.message || "Login failed. Please try again.");
        } finally {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      });
    }

    const registerFormElement = document.getElementById("registerFormElement");
    if (registerFormElement) {
      registerFormElement.addEventListener("submit", async (e) => {
        e.preventDefault();
        const registerError = document.getElementById("registerError");
        hideError(registerError);

        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const role = document.getElementById("registerRole").value.toUpperCase();
        const username = document.getElementById("username").value;

        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.textContent = "Creating Account...";
        submitButton.disabled = true;

        if (password !== confirmPassword) {
          showError(registerError, "Passwords do not match");
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        try {
          await apiRequest("register", "POST", { email, password, username, role });
          alert("Registration Successful! Please log in.");
          toggleForm("login");
        } catch (error) {
          showError(registerError, error.message || "Registration failed. Please try again.");
        } finally {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      });
    }
  });
</script>

  </body>
</html>